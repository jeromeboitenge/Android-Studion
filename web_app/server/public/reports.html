<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Machine System</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="professional.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <header>
        <h1>Machine Management System</h1>
        <nav>
            <ul style="list-style: none; padding: 0; margin: 10px 0 0 0; display: flex; justify-content: center; gap: 20px;">
                <li><a href="index.html" style="color: rgba(255,255,255,0.8); text-decoration: none;">Dashboard</a></li>
                <li><a href="management.html" style="color: rgba(255,255,255,0.8); text-decoration: none;">Management</a></li>
                <li><a href="brands.html" style="color: rgba(255,255,255,0.8); text-decoration: none;">Brands</a></li>
                <li><a href="reports.html" style="color: white; text-decoration: none; font-weight: bold; border-bottom: 2px solid white;">Reports</a></li>
            </ul>
        </nav>
    </header>

    <main style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
        <!-- Report Header -->
        <div class="report-card">
            <div class="report-header">
                <div>
                    <h2 style="margin: 0;">Inventory Reports & Analytics</h2>
                    <p style="color: #666; margin: 5px 0 0 0;">Comprehensive insights into your machine fleet</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="exportReport()" class="export-btn">
                        üìä Export CSV
                    </button>
                    <button onclick="printReport()" class="export-btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        üñ®Ô∏è Print
                    </button>
                </div>
            </div>

            <!-- Summary Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
                    <div style="font-size: 0.9rem; opacity: 0.9;">Total Machines</div>
                    <div id="reportTotal" style="font-size: 2.5rem; font-weight: bold; margin-top: 5px;">-</div>
                </div>
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
                    <div style="font-size: 0.9rem; opacity: 0.9;">Active Machines</div>
                    <div id="reportActive" style="font-size: 2.5rem; font-weight: bold; margin-top: 5px;">-</div>
                </div>
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white;">
                    <div style="font-size: 0.9rem; opacity: 0.9;">Inactive Machines</div>
                    <div id="reportInactive" style="font-size: 2.5rem; font-weight: bold; margin-top: 5px;">-</div>
                </div>
                <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 10px; color: white;">
                    <div style="font-size: 0.9rem; opacity: 0.9;">Total Brands</div>
                    <div id="reportBrands" style="font-size: 2.5rem; font-weight: bold; margin-top: 5px;">-</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div class="chart-container">
                <h3 style="margin: 0 0 15px 0; color: var(--primary-color);">Status Distribution</h3>
                <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 style="margin: 0 0 15px 0; color: var(--primary-color);">Brand Distribution</h3>
                <canvas id="brandChart"></canvas>
            </div>
        </div>

        <!-- Detailed Report Table -->
        <div class="report-card">
            <h3 style="color: var(--primary-color); margin-top: 0;">Detailed Inventory Report</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">Generated: <span id="reportDate"></span></p>
            
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortReportTable(0)">ID ‚Üï</th>
                            <th onclick="sortReportTable(1)">Machine Name ‚Üï</th>
                            <th onclick="sortReportTable(2)">Serial Number ‚Üï</th>
                            <th onclick="sortReportTable(3)">Brand ‚Üï</th>
                            <th onclick="sortReportTable(4)">Location ‚Üï</th>
                            <th onclick="sortReportTable(5)">Status ‚Üï</th>
                            <th onclick="sortReportTable(6)">Created ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="utils.js"></script>
    <script>
        let currentSortColumn = -1;
        let currentSortAscending = true;
        let allMachines = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadReportData();
        });

        async function loadReportData() {
            try {
                const summary = await generateReportSummary();
                if (!summary) return;

                // Update stats
                document.getElementById('reportTotal').textContent = summary.totalMachines;
                document.getElementById('reportActive').textContent = summary.activeMachines;
                document.getElementById('reportInactive').textContent = summary.inactiveMachines;
                document.getElementById('reportBrands').textContent = summary.totalBrands;
                document.getElementById('reportDate').textContent = summary.generatedAt;

                // Store machines for export
                allMachines = summary.machines;

                // Create charts
                createStatusChart(summary.activeMachines, summary.inactiveMachines);
                createBrandChart(summary.machines);

                // Populate table
                populateReportTable(summary.machines);

                Toast.success('Report loaded successfully');
            } catch (error) {
                console.error('Error loading report:', error);
                Toast.error('Failed to load report data');
            }
        }

        function populateReportTable(machines) {
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';

            machines.forEach(m => {
                const tr = document.createElement('tr');
                const statusClass = m.status === 'Active' ? 'badge-success' : 'badge-danger';
                
                tr.innerHTML = `
                    <td>${m.id}</td>
                    <td><strong>${m.name}</strong></td>
                    <td>${m.serial_number}</td>
                    <td>${m.brand_name || 'N/A'}</td>
                    <td>${m.location || 'N/A'}</td>
                    <td><span class="badge ${statusClass}">${m.status}</span></td>
                    <td>${formatDate(m.created_at)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function sortReportTable(column) {
            if (currentSortColumn === column) {
                currentSortAscending = !currentSortAscending;
            } else {
                currentSortColumn = column;
                currentSortAscending = true;
            }

            const table = document.querySelector('.data-table');
            sortTable(table, column, currentSortAscending);
        }

        function exportReport() {
            if (allMachines.length === 0) {
                Toast.warning('No data to export');
                return;
            }

            const exportData = allMachines.map(m => ({
                ID: m.id,
                Name: m.name,
                'Serial Number': m.serial_number,
                Brand: m.brand_name || 'N/A',
                Location: m.location || 'N/A',
                Status: m.status,
                'Created Date': formatDate(m.created_at)
            }));

            const timestamp = new Date().toISOString().split('T')[0];
            exportToCSV(exportData, `machine-inventory-report-${timestamp}.csv`);
        }
    </script>
</body>
</html>
